# SF-RDF-ACL 技术缺陷与改进清单

> 生成时间：2025-10-18
> 项目路径：d:/coding/OntologyGraph/projects/sf-rdf-acl
> 对照标准：RDF防腐层深化设计.md v2

## 一、功能缺陷清单

### 1. Connection 模块缺陷

#### 1.1 连接池管理缺失
- **问题**：每次请求创建新连接，无复用机制
- **影响**：性能低下，连接开销大
- **建议实现**：
```python
class ConnectionPool:
    def __init__(self, max_connections=10):
        self._pool = []
        self._max = max_connections

    async def get_connection(self):
        # 实现连接获取逻辑
        pass

    async def release(self, conn):
        # 实现连接释放逻辑
        pass
```

#### 1.2 健康检查不完善
- **问题**：health() 方法过于简单，未检查实际服务状态
- **位置**：`src/sf_rdf_acl/connection/client.py:62`
- **建议**：增加数据集可用性检查、查询响应时间检测

### 2. Query 模块缺陷

#### 2.1 聚合查询缺失
- **设计要求**：支持轻量 count/distinct/group_by
- **当前状态**：完全未实现
- **需要添加**：
```python
class AggregateQuery:
    def __init__(self):
        self.aggregates = []

    def count(self, var: str):
        # COUNT 实现
        pass

    def group_by(self, vars: List[str]):
        # GROUP BY 实现
        pass
```

#### 2.2 安全编译器不完整
- **问题**：缺少参数化占位符、SQL 注入防护
- **位置**：`src/sf_rdf_acl/query/builder.py`
- **严重性**：高（安全风险）

#### 2.3 语言标签处理缺失
- **设计要求**：支持语言标签和大小写处理
- **当前状态**：未实现
- **影响**：无法处理多语言数据

### 3. Transaction 模块缺陷

#### 3.1 审计功能未完成
- **问题**：`audit.py` 文件存在但功能不完整
- **缺失**：
  - PostgreSQL 表结构定义
  - 审计日志写入逻辑
  - 操作追踪链路

#### 3.2 批量操作优化缺失
- **设计要求**：跨图分批（如 10k/批）
- **当前状态**：未实现批量优化
- **性能影响**：大数据量操作性能差

#### 3.3 事务回滚机制简陋
- **问题**：`_RollbackEntry` 定义存在但未充分使用
- **位置**：`src/sf_rdf_acl/transaction/manager.py:24`

### 4. Converter 模块缺陷

#### 4.1 GraphFormatter 功能缺失
- **设计要求**：支持 Turtle/JSON-LD/GraphJSON
- **当前状态**：仅 Turtle 透传
- **影响**：无法满足不同格式需求

#### 4.2 类型映射不完整
- **问题**：ResultMapper 类型转换有限
- **缺失类型**：
  - dateTime 完整支持
  - 自定义数据类型
  - 复杂嵌套结构

### 5. Graph 模块缺陷

#### 5.1 图投影功能不完整
- **问题**：GraphProjectionBuilder 实现简单
- **缺失**：
  - edgePredicates 过滤
  - includeLiterals 选项
  - limit 参数支持

#### 5.2 图级权限管理缺失
- **设计要求**：图级权限占位
- **当前状态**：完全未实现
- **安全影响**：无访问控制

### 6. Provenance 模块缺陷

#### 6.1 RDF* 语法支持不明确
- **问题**：对 RDF* 的支持程度未经充分测试
- **风险**：可能无法处理复杂溯源语句

#### 6.2 元数据字段不完整
- **缺失字段**：
  - confidence（置信度）
  - evidence（证据）
  - extractionJob（抽取作业）

### 7. Utils 模块缺陷

#### 7.1 工具函数过少
- **当前**：仅有 `resolve_graph_iri`
- **缺失**：
  - IRI 验证工具
  - 前缀管理工具
  - 时间处理工具
  - 配置验证工具

## 二、测试缺陷清单

### 1. 测试结构问题

#### 1.1 Legacy 测试未迁移
- **问题**：16 个测试文件在 legacy 目录
- **影响**：可能与新架构不兼容
- **行动**：逐个验证并迁移

#### 1.2 新功能无测试
- **完全无测试的模块**：
  - provenance
  - utils
  - audit

### 2. 测试场景缺失

#### 2.1 异常场景
- Fuseki 服务不可用
- 网络超时
- 并发冲突
- 数据格式错误

#### 2.2 性能测试
- 大数据量处理
- 并发请求
- 内存泄漏检测

#### 2.3 集成测试
- 与 sf-common 集成
- 与 PostgreSQL 集成
- 端到端业务流程

## 三、示例代码缺陷

### 1. 错误处理缺失
所有示例都缺少 try-except 块：
```python
# 当前代码（错误）
result = await client.select(query)

# 应该改为
try:
    result = await client.select(query)
except ExternalServiceError as e:
    logger.error(f"查询失败: {e}")
    # 处理错误
```

### 2. 复杂场景未覆盖
- 批量 upsert 示例
- 事务回滚示例
- 并发操作示例
- 性能优化示例

## 四、配置与依赖问题

### 1. 依赖版本未锁定
**文件**：`pyproject.toml`
**问题**：部分依赖使用 "^" 版本，可能导致兼容性问题

### 2. 配置模板缺失
**需要提供**：
- 开发环境配置模板
- 生产环境配置模板
- Docker 配置示例

## 五、紧急修复清单（按优先级）

### P0 - 立即修复（影响核心功能）

1. **安全问题**
   - [ ] Query Builder 添加 SQL 注入防护
   - [ ] 添加参数验证和转义

2. **核心功能**
   - [ ] 完成 GraphFormatter JSON-LD 支持
   - [ ] 实现基础聚合查询（COUNT）
   - [ ] 修复 审计日志功能

3. **测试覆盖**
   - [ ] 为核心模块添加单元测试
   - [ ] 添加异常处理测试

### P1 - 短期修复（1-2周）

1. **性能优化**
   - [ ] 实现连接池
   - [ ] 添加批量操作优化
   - [ ] 实现查询结果缓存

2. **功能完善**
   - [ ] 完成 Model-Aware Operator
   - [ ] 增强 Provenance 支持
   - [ ] 添加图级权限框架

3. **文档改进**
   - [ ] 完善 API 文档
   - [ ] 添加架构图
   - [ ] 提供迁移指南

### P2 - 中期改进（1个月）

1. **扩展功能**
   - [ ] SHACL 校验集成
   - [ ] 联邦查询支持
   - [ ] 高级图算法集成

2. **监控与运维**
   - [ ] 完善指标收集
   - [ ] 添加告警机制
   - [ ] 性能基准测试

## 六、代码质量问题

### 1. 类型提示不完整
多处使用 `Any` 类型，降低代码可维护性

### 2. 文档字符串不规范
部分函数缺少完整的 docstring

### 3. 错误处理不一致
有些地方抛出异常，有些返回 None

### 4. 魔法数字
代码中存在硬编码的数值，应提取为配置

## 七、建议的开发计划

### 第一阶段（1周）
- 修复 P0 安全和核心功能问题
- 迁移 legacy 测试
- 完善错误处理

### 第二阶段（2周）
- 实现缺失的核心功能
- 添加完整测试覆盖
- 优化性能瓶颈

### 第三阶段（2周）
- 完善文档和示例
- 进行集成测试
- 准备生产部署

### 第四阶段（持续）
- 监控和优化
- 功能迭代
- 生态集成

---

*本清单将作为技术债务跟踪的基准文档，建议在项目管理工具中创建对应的任务项。*